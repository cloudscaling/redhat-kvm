heat_template_version: 2016-04-08

description: >
  Extra ScaleIO configuration

parameters:
  controller_servers:
    type: json
  compute_servers:
    type: json
  blockstorage_servers:
    type: json
  objectstorage_servers:
    type: json
  cephstorage_servers:
    type: json
  DeployIdentifier:
    type: string
    description: Value which changes if the node configuration may need to be re-applied

resources:

  ScaleIOPrepareConfig:
    type: OS::ScaleIO::ScaleIODeploymentData
    depends_on: AllServers
    properties:
      servers:
        list_join:
          - ''
          - - {get_param: controller_servers}
            - {get_param: compute_servers}
            - {get_param: blockstorage_servers}

  ExtraConfigFile1:
    type: OS::Heat::SoftwareConfig
    properties:
      group: script
      config:
        get_file: 01_prepare_repo.sh
  ScaleIODeployment_Step01:
    type: OS::Heat::SoftwareDeployments
    depends_on: ScaleIOPrepareConfig
    properties:
      name: ScaleIODeployment_Step01
      servers: {get_attr: [ScaleIOPrepareConfig, servers]}
      config: {get_resource: ExtraConfigFile1}
      input_values:
        update_identifier: {get_param: DeployIdentifier}

  ExtraConfigFile2:
    type: OS::Heat::SoftwareConfig
    properties:
      group: script
      config:
        get_file: 02_install_packages.sh
  ScaleIODeployment_Step02:
    type: OS::Heat::SoftwareDeployments
    depends_on: ScaleIODeployment_Step01
    properties:
      name: ScaleIODeployment_Step02
      servers: {get_attr: [ScaleIOPrepareConfig, servers]}
      config: {get_resource: ExtraConfigFile2}
      input_values:
        update_identifier: {get_param: DeployIdentifier}

  ExtraConfigFile3:
    type: OS::Heat::SoftwareConfig
    properties:
      group: script
      config:
        get_file: 03_configure_cluster.sh
  ScaleIODeployment_Step03:
    type: OS::Heat::SoftwareDeployments
    depends_on: ScaleIODeployment_Step02
    properties:
      name: ScaleIODeployment_Step03
      servers: {get_attr: [ScaleIOPrepareConfig, servers]}
      config: {get_resource: ExtraConfigFile3}
      input_values:
        update_identifier: {get_param: DeployIdentifier}

  # TODO: configure SDC, configure OpenStack services


  # Note, this should come last, so use depends_on to ensure
  # this is created after any other resources.
  ExtraDeployments:
    type: OS::Heat::None
    depends_on: ScaleIODeployment_Step03
